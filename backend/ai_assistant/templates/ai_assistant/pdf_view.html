<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer: {{ uploaded_file.filename }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        .pdf-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 20px;
        }
        .search-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .page-controls {
            background: #e9ecef;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        #pdf-viewer {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            min-height: 600px;
            position: relative;
        }
        .search-highlight {
            background-color: yellow;
            opacity: 0.7;
        }
        .search-highlight.current {
            background-color: orange;
            font-weight: bold;
        }
        #search-results-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        .search-result-item {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            border-left: 3px solid #007bff;
        }
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        .btn-sm {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="pdf-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">{{ uploaded_file.filename }}</h4>
                <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">
                    ← Back
                </a>
            </div>
            
            <div class="search-controls">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="search-term" class="form-control" placeholder="Search text in PDF...">
                            <button id="search-btn" class="btn btn-primary">Search</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <button id="prev-match" class="btn btn-outline-info btn-sm me-2" style="display:none;">← Prev</button>
                            <button id="next-match" class="btn btn-outline-info btn-sm me-2" style="display:none;">Next →</button>
                            <span id="search-result" class="text-muted small"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-controls">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <button id="prev-page" class="btn btn-secondary btn-sm me-2">← Previous</button>
                            <button id="next-page" class="btn btn-secondary btn-sm me-2">Next →</button>
                            <span class="text-muted me-3">Page <span id="page-num">1</span> of <span id="page-count">1</span></span>
                            <div class="input-group" style="width: 150px;">
                                <input type="number" id="jump-page" min="1" class="form-control form-control-sm" placeholder="Page">
                                <button id="go-page" class="btn btn-primary btn-sm">Go</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="text-muted small">Use mouse wheel to navigate pages</span>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-9">
                    <div id="pdf-viewer"></div>
                </div>
                <div class="col-md-3">
                    <div id="search-results-list" style="max-height: 600px; overflow-y: auto; display:none;">
                        <h6 class="mb-3">Search Results</h6>
                        <ul class="list-group list-group-flush" id="search-results-ul"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const url = "{{ pdf_url }}";
            console.log('PDF URL from template:', url);
            
            const pdfjsLib = window['pdfjsLib'];
            if (!pdfjsLib) {
                console.error("PDF.js library not loaded");
                alert("PDF.js library not loaded. Please refresh the page.");
                return;
            }
            
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const container = document.getElementById('pdf-viewer');
            let pdfDoc = null;
            let pageNum = parseInt("{{ page|default:'1' }}") || 1;
            let pageCount = 1;
            let matches = [];
            let currentMatchIdx = 0;
            let currentSearchTerm = "";
            let searchResults = [];

            function renderPage(num, highlightTerm) {
                console.log('Rendering page:', num);
                pdfDoc.getPage(num).then(function(page) {
                    console.log('Page loaded successfully');
                    const viewport = page.getViewport({scale: 1.5});
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    container.innerHTML = '';
                    container.appendChild(canvas);
                    
                    page.render({canvasContext: context, viewport: viewport}).promise.then(function() {
                        console.log('Page rendered successfully');
                        if (highlightTerm) {
                            page.getTextContent().then(function(textContent) {
                                const textLayerDiv = document.createElement('div');
                                textLayerDiv.style.position = 'absolute';
                                textLayerDiv.style.top = 0;
                                textLayerDiv.style.left = 0;
                                textLayerDiv.style.height = canvas.height + 'px';
                                textLayerDiv.style.width = canvas.width + 'px';
                                textLayerDiv.style.pointerEvents = 'none';
                                textLayerDiv.style.zIndex = 10;
                                container.appendChild(textLayerDiv);

                                // Find all matches and highlight them
                                matches = [];
                                textContent.items.forEach(function(item, idx) {
                                    const text = item.str;
                                    const lowerText = text.toLowerCase();
                                    const lowerTerm = highlightTerm.toLowerCase();
                                    let startIdx = 0;
                                    while (true) {
                                        const matchIdx = lowerText.indexOf(lowerTerm, startIdx);
                                        if (matchIdx === -1) break;
                                        matches.push({item, idx, matchIdx});
                                        startIdx = matchIdx + lowerTerm.length;
                                    }
                                });

                                // Highlight all matches
                                matches.forEach(function(match, i) {
                                    const span = document.createElement('span');
                                    span.textContent = match.item.str;
                                    span.style.position = 'absolute';
                                    span.style.left = (match.item.transform[4] * 1.5) + 'px';
                                    span.style.top = (canvas.height - match.item.transform[5] * 1.5) + 'px';
                                    span.style.background = (i === currentMatchIdx) ? 'orange' : 'yellow';
                                    span.style.fontWeight = (i === currentMatchIdx) ? 'bold' : '';
                                    span.style.opacity = '0.8';
                                    span.style.padding = '1px 2px';
                                    span.style.borderRadius = '2px';
                                    textLayerDiv.appendChild(span);
                                });

                                // Show navigation if multiple matches
                                document.getElementById('prev-match').style.display = matches.length > 1 ? '' : 'none';
                                document.getElementById('next-match').style.display = matches.length > 1 ? '' : 'none';
                                document.getElementById('search-result').textContent = matches.length
                                    ? `Match ${currentMatchIdx + 1} of ${matches.length} on page ${num}`
                                    : 'No matches on this page';
                            });
                        } else {
                            document.getElementById('prev-match').style.display = 'none';
                            document.getElementById('next-match').style.display = 'none';
                            document.getElementById('search-result').textContent = '';
                        }
                    });
                    document.getElementById('page-num').textContent = num;
                    document.getElementById('page-count').textContent = pageCount;
                }).catch(function(error) {
                    console.error('Error rendering page:', error);
                });
            }

            console.log('Loading PDF document from URL:', url);
            pdfjsLib.getDocument(url).promise.then(function(pdf) {
                console.log('PDF document loaded successfully');
                pdfDoc = pdf;
                pageCount = pdf.numPages;
                console.log('Total pages:', pageCount);
                renderPage(pageNum);

                // Page navigation
                document.getElementById('prev-page').onclick = function() {
                    if (pageNum <= 1) return;
                    pageNum--;
                    renderPage(pageNum, currentSearchTerm);
                };
                document.getElementById('next-page').onclick = function() {
                    if (pageNum >= pageCount) return;
                    pageNum++;
                    renderPage(pageNum, currentSearchTerm);
                };
                document.getElementById('go-page').onclick = function() {
                    const input = document.getElementById('jump-page');
                    const val = parseInt(input.value);
                    if (val >= 1 && val <= pageCount) {
                        pageNum = val;
                        renderPage(pageNum, currentSearchTerm);
                    }
                };

                // Search functionality
                document.getElementById('search-btn').onclick = function() {
                    const term = document.getElementById('search-term').value.trim();
                    if (!term) return;
                    currentSearchTerm = term;
                    let searchResult = document.getElementById('search-result');
                    searchResult.textContent = 'Searching...';
                    searchResults = [];
                    
                    // Search each page for the term and build result list
                    (function searchPage(n) {
                        if (n > pageCount) {
                            searchResult.textContent = searchResults.length ? `Found on ${searchResults.length} page(s)` : 'Not found';
                            updateSearchResultsList();
                            if (searchResults.length) {
                                pageNum = searchResults[0].page;
                                currentMatchIdx = 0;
                                renderPage(pageNum, term);
                            }
                            return;
                        }
                        pdfDoc.getPage(n).then(function(page) {
                            page.getTextContent().then(function(textContent) {
                                const text = textContent.items.map(item => item.str).join(' ');
                                if (text.toLowerCase().includes(term.toLowerCase())) {
                                    searchResults.push({page: n, preview: text.substr(0, 100)});
                                }
                                searchPage(n + 1);
                            });
                        });
                    })(1);
                };

                function updateSearchResultsList() {
                    const listDiv = document.getElementById('search-results-list');
                    const ul = document.getElementById('search-results-ul');
                    ul.innerHTML = '';
                    if (searchResults.length) {
                        listDiv.style.display = '';
                        searchResults.forEach(function(result, idx) {
                            const li = document.createElement('li');
                            li.className = 'search-result-item';
                            li.textContent = `Page ${result.page}: ...${result.preview}...`;
                            li.onclick = function() {
                                pageNum = result.page;
                                currentMatchIdx = 0;
                                renderPage(pageNum, currentSearchTerm);
                            };
                            ul.appendChild(li);
                        });
                    } else {
                        listDiv.style.display = 'none';
                    }
                }

                // Match navigation
                document.getElementById('prev-match').onclick = function() {
                    if (matches.length > 1) {
                        currentMatchIdx = (currentMatchIdx - 1 + matches.length) % matches.length;
                        renderPage(pageNum, currentSearchTerm);
                    }
                };
                document.getElementById('next-match').onclick = function() {
                    if (matches.length > 1) {
                        currentMatchIdx = (currentMatchIdx + 1) % matches.length;
                        renderPage(pageNum, currentSearchTerm);
                    }
                };

                // Keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    if (e.target.tagName === 'INPUT') return; // Don't interfere with input fields
                    
                    switch(e.key) {
                        case 'ArrowLeft':
                            if (pageNum > 1) {
                                pageNum--;
                                renderPage(pageNum, currentSearchTerm);
                            }
                            break;
                        case 'ArrowRight':
                            if (pageNum < pageCount) {
                                pageNum++;
                                renderPage(pageNum, currentSearchTerm);
                            }
                            break;
                        case 'f':
                            if (e.ctrlKey || e.metaKey) {
                                e.preventDefault();
                                document.getElementById('search-term').focus();
                            }
                            break;
                    }
                });

                // Mouse wheel for page navigation
                container.addEventListener('wheel', function(e) {
                    if (e.deltaY > 0) {
                        if (pageNum < pageCount) {
                            pageNum++;
                            renderPage(pageNum, currentSearchTerm);
                        }
                    } else if (e.deltaY < 0) {
                        if (pageNum > 1) {
                            pageNum--;
                            renderPage(pageNum, currentSearchTerm);
                        }
                    }
                });

                // Enter key in search field
                document.getElementById('search-term').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('search-btn').click();
                    }
                });

            }).catch(function(error) {
                console.error('Error loading PDF document:', error);
                container.innerHTML = '<div class="alert alert-danger">Error loading PDF document: ' + error.message + '</div>';
            });
        });
    </script>
</body>
</html>
