{% extends "pdfimport/base.html" %}
{% block section_title %}RAG Query with Qwen{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-8" id="main-panel">
    <div id="rag-form-section">
      <form method="post" class="row g-2 align-items-center">
        {% csrf_token %}
        <div class="col-auto">
          <input type="text" name="query" class="form-control" placeholder="Enter your question..." style="width: 350px;">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Ask Qwen</button>
        </div>
      </form>
      {% if message %}
      <div class="alert alert-danger mt-3">{{ message }}</div>
      {% endif %}
    </div>
    <div id="rag-loading" style="display:none; text-align:center; margin-top:2em;">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-3">Qwen is thinking... Please wait.</div>
    </div>
    <div id="rag-detail-panel">
      {% if response_data %}
      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <strong>Qwen's Response</strong>
        </div>
        <div class="card-body">
          <p class="mb-0" style="white-space: pre-line;">{{ response_data.response }}</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header bg-light">
          <strong>Source Documents</strong>
        </div>
        <div class="card-body p-0">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th style="width: 120px;">Document ID</th>
                <th>Content Preview</th>
                <th>PDF</th>
              </tr>
            </thead>
            <tbody>
              {% for source in response_data.sources %}
              <tr>
                <td>{{ source.id }}</td>
                <td>{{ source.content|truncatechars:200 }}</td>
                <td>
                  {% if source.uploaded_file_id and source.page_number %}
                  <a href="{% url 'pdf_view' source.uploaded_file_id %}?page={{ source.page_number }}" target="_blank">View PDF</a>
                  {% else %}
                  N/A
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  <div class="col-md-4 border-start" id="history-sidebar">
    {% if query_history and query_history|length > 0 %}
    <div class="mb-4">
      <h6>Query History</h6>
      <ul class="list-group mb-2" id="history-list">
        {% for item in query_history %}
        <li class="list-group-item history-item" data-index="{{ forloop.counter0 }}" style="cursor:pointer;">
          <strong>Q:</strong> {{ item.query|truncatechars:40 }}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <div id="history-detail" style="display:none;"></div>
  </div>
</div>
<script id="history-data" type="application/json">{{ query_history_json|safe }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const formSection = document.getElementById('rag-form-section');
  const loadingDiv = document.getElementById('rag-loading');
  const form = formSection.querySelector('form');
  if (form) {
    form.addEventListener('submit', function() {
      formSection.style.display = 'none';
      loadingDiv.style.display = '';
    });
  }
  // History click logic
  const historyItems = document.querySelectorAll('.history-item');
  const historyDetail = document.getElementById('history-detail');
  const historyData = JSON.parse(document.getElementById('history-data').textContent);
  historyItems.forEach(function(item) {
    item.addEventListener('click', function() {
      const idx = parseInt(item.getAttribute('data-index'));
      const entry = historyData[idx];
      let html = `<div class='card mb-3'><div class='card-header bg-info text-white'><strong>Q:</strong> ${entry.query}</div><div class='card-body'><strong>A:</strong><br><div style='white-space:pre-line;'>${entry.response}</div></div></div>`;
      if (entry.sources && entry.sources.length > 0) {
        html += `<div class='card'><div class='card-header bg-light'><strong>Source Documents</strong></div><div class='card-body p-0'><table class='table table-striped mb-0'><thead><tr><th>Document ID</th><th>Content Preview</th></tr></thead><tbody>`;
        entry.sources.forEach(function(src) {
          html += `<tr><td>${src.id || ''}</td><td>${(src.content || '').slice(0,200)}</td></tr>`;
        });
        html += `</tbody></table></div></div>`;
      }
      historyDetail.innerHTML = html;
      historyDetail.style.display = '';
      // Scroll to detail panel if on mobile
      if (window.innerWidth < 768) {
        historyDetail.scrollIntoView({behavior:'smooth'});
      }
    });
  });
});
</script>
{% endblock %} 